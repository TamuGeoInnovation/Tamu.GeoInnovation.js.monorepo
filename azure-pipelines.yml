variables:
  - name: excludedProjects
    value: 'signage-angular,trees-angular,two-dashboard-angular,two-data-api-nest,two-angular,geoservices-angular,covid-data-api-nest,two-valup-nest,two-directory-nest'
  - name: isDevelopment
    value: $[eq(variables['Build.SourceBranchName'], 'development')]
  - name: isMaster
    value: $[eq(variables['Build.SourceBranchName'], 'master')]
  - name: affectedBase
    ${{ if and(ne(variables['Build.SourceBranchName'], 'master'), ne(variables['Build.SourceBranchName'], 'development')) }}:
      value: origin/development # Default affected base base
    ${{ if eq(variables['Build.SourceBranchName'], 'development') }}:
      value: origin/development~ # Affected base if build branch name is development
    ${{ if eq(variables['Build.SourceBranchName'], 'master') }}:
      value: origin/master~ # Affected base if build branch name is master

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Dependencies
    jobs:
      - template: templates/jobs/cacheOrRestoreDependencies.yml

  - stage: Lint
    dependsOn: Dependencies
    jobs:
      - template: templates/jobs/lintProjects.yml

  - stage: Build
    dependsOn: Dependencies
    jobs:
      - template: templates/jobs/build.yml
        parameters:
          buildType: development
          excludedProjects: $(excludedProjects)
      - template: templates/jobs/build.yml
        parameters:
          buildType: staging
          excludedProjects: $(excludedProjects)
      - template: templates/jobs/build.yml
        parameters:
          buildType: production
          excludedProjects: $(excludedProjects)

  - stage: Tag
    dependsOn: Build
    jobs:
      - template: templates/jobs/buildTags.yml
        parameters:
          excludedProjects: $(excludedProjects)
